server {
  listen   80;
  server_name  <%= node['hostname'] %>;

  access_log  <%= node['nginx']['log_dir'] %>/localhost.access.log;

  location / { try_files $uri @<%= @name %>; }
  location @<%= @name %> {
    <% if @force_https %>
    if ($http_x_forwarded_proto != 'https') {
      rewrite ^ https://$host$request_uri? permanent;
    }
    <% end %>
    uwsgi_pass unix:/tmp/uwsgi.<%= @name %>.sock;
    include uwsgi_params;
    proxy_set_header X-Request-Start "t=${msec}";
  }
  <% if @static %>
  location <%= @static['uri'] %> {
    alias <%= @home_path %><%= @static['path'] %>;
    expires max;
  }
  <% end %>
}
