<% if @force_https %>
server {
  listen 80;
  server_name <%= node['hostname'] %>;
  
  access_log <%= node['nginx']['log_dir'] %>/localhost.access.redirect.log;
  expires max;
  return 301 https://$host$request_uri;
}
<% end %>
server {
  listen <% if @force_https %>443<% else %>80<% end %>;
  server_name  <%= node['hostname'] %>;

  access_log  <%= node['nginx']['log_dir'] %>/localhost.access.log;

  location / { try_files $uri @<%= @name %>; }
  location @<%= @name %> {
    uwsgi_pass unix:/tmp/uwsgi.<%= @name %>.sock;
    include uwsgi_params;
    proxy_set_header X-Request-Start "t=${msec}";
  }
  <% if @static %>
  location <%= @static['uri'] %> {
    alias <%= @home_path %><%= @static['path'] %>;
    expires max;
  }
  <% end %>
}
